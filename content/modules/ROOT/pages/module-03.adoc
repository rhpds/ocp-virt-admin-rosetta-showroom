= Hot Plugging Resources

In this module, you will perform three tasks:

. <<cpu,Increase the CPU and Memory of a running VM>>
. <<disk,Add a virtual disk to a running VM and then make it persistent>>
. <<nic,Add a network interface (NIC) to a virtual machine>>

[#cpu]
== Adding CPU and Memory to a running VM
In this lab, we will add more CPU and Memory resources to a virtual machine by changing the virtual machine’s Instance Type. To do this, you will start with an existing VM that has a single vCPU and 2 GiB of memory. Using the OpenShift Virtualization console, you will modify the configuration of the VM Instance Type to a type that has 2 vCPU and 4 GiB of memory.

[start=1]
. Login to the OpenShift console using the credentials provided to you by the lab administrator. Navigate to Virtualization -> Virtual Machines, and select the virtualmachines project. Select the VM named vm01.
Note that the InstanceType of this VM is u1.small. Above the InstanceType, you can see that the CPU | Memory for this VM is 1 CPU | 2GiB Memory. This is the current configuration for this VM.

image::exercise3/03-image-cpu-001.png[title="CPU and Memory before hot plug", link=self, window=blank, width=100%]

[start=2]
. Click on the Configuration tab and select Details, if it is not already selected.  Note that the InstanceType is General Purpose and 1 CPU | 2GiB Memory.
image::exercise3/03-image-cpu-002.png[title="Virtual Machine details", link=self, window=blank, width=100%]

[start=3]
. Click on the blue pencil icon to modify the CPU and Memory resources.  In the window that appears, pull down the Size menu and select 2xmedium: 2CPUs, 4Gi Memory.
Click the Save button.
image::exercise3/03-image-cpu-003.png[title="Edit Instance Type", link=self, window=blank, width=100%]

[start=4]
. The configuration in the Details panel will now show that the virtual machine has 2 CPUs and 4 GiB of memory.
image::exercise3/03-image-cpu-004.png[title="Virtual Machine details", link=self, window=blank, width=100%]

[start=5]
. Click on the Console tab and view the console window of the VM. You will see messages from the kernel that additional CPU and memory are now available.
image::exercise3/03-image-cpu-005.png[title="CPU and Memory messages", link=self, window=blank, width=100%]

[start=6]
. Verify the new resources by logging in to the VM using the credentials at the top of the console window. In this case, the username is rhel and the password is redhat.

NOTE: In order for the new CPU and Memory configuration to take effect, the virtual machine will automatically migrate from one worker node to another. If the new CPU and Memory configuration does not appear immediately, you may have to wait a few minutes.
image::exercise3/03-image-cpu-006.png[title="Login to VM", link=self, window=blank, width=100%]

[start=7]
. To validate that the VM now has 2 CPUs, run the command:
...
  $ grep processor /proc/cpuinfo
...
You will see that two processors exist.
To validate that the VM now has 4GiB of memory, run the command:
...
  $ free -m
...
You will see that the VM has 3669 MiB of total memory.

NOTE: This VM image has kdump enabled, which reserves some memory for the kernel. This is why the memory amount appears to be less than 4 GiB. In fact, 4 GiB of memory is configured for the VM, but the operating system sees a lower number. If kdump were disabled, the total memory would be 4 GiB.
image::exercise3/03-image-cpu-007.png[title="Verify new resources", link=self, window=blank, width=100%]

[#disk]
== Adding a virtual disk to a running VM

[#nic]
== Adding a NIC to a running VM
In this lab, we will add a new network interface connection (NIC) to an existing VM. To do this, you will start with an existing VM that has a single NIC on the pod network. Using the OpenShift Virtualization console, you will modify the configuration of the VM to include an additional NIC on a new network. You complete the hot plug action by live-migrating the VM to another worker node.

[start=1]
. Login to the OpenShift console using the credentials provided to you by the lab administrator. Navigate to Virtualization -> Virtual Machines, and select the virtualmachines project. Select the VM named vm01.

[start=2]
. Take note of the worker node on which the VM is running (e.g. worker-cluster-s67qr-1)
image::exercise3/03-image-nic-002.png[title="Identify the worker node", link=self, window=blank, width=100%]

[start=3]
. Click on the Configuration tab and select Network. Note that the VM currently has a single NIC.
image::exercise3/03-image-nic-003a.png[title="Single NIC only", link=self, window=blank, width=100%]

You may also login to the VM via the Console tab and view the NIC details from the operating system.

image::exercise3/03-image-nic-003b.png[title="Single NIC in Console", link=self, window=blank, width=100%]

[start=4]
. Back in the Network configuration screen, click on the button “Add network interface”. Provide a name for the new interface, such as nic-1. The model should be virtio, and the Network should be default/east-west-nad. 
Click on the Save button.
image::exercise3/03-image-nic-004.png[title="Add network interface", link=self, window=blank, width=100%]


[start=5]
. Click on the “>” symbol next to the “Pending changes” banner that has appeared below the VM name and note that the message indicates a restart or migration is required for the NIC addition to take effect.
image::exercise3/03-image-nic-005.png[title="View pending changes", link=self, window=blank, width=100%]

[start=6]
. Although it is possible at this time to simply restart the VM, we are trying to hot plug the NIC, so instead we will initiate a  live migration. During a live migration, the VM will move from one worker node to another while the VM is still running.
image::exercise3/03-image-nic-006.png[title="Migrate the VM", link=self, window=blank, width=100%]

[start=7]
. Follow the steps from Module 1 to live migrate the VM from one node to any other worker node. Once the migration has completed, continue with this module.

[start=8]
. Navigate back to the Console tab and you may see messages have appeared on the VM console that new hardware has been added. You can view the new NIC from the operating system by running the command ip address and viewing the output.
image::exercise3/03-image-nic-008.png[title="Messages on consoel about new NIC", link=self, window=blank, width=100%]

[start=9]
. The new NIC is now available for use (enp3s0).
image::exercise3/03-image-nic-009.png[title="New NIC is up", link=self, window=blank, width=100%]
